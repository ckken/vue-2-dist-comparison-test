# Vue.js 构建一致性测试项目

这是一个用于测试 Vue CLI 构建工具在不同场景下构建结果一致性的项目。

## 项目概述

本项目包含一个完整的 Vue.js 应用和专门的测试脚本，用于验证：
- 相同代码多次构建的一致性
- 代码修改后构建结果的变化
- 高负载并行构建的一致性

## 项目结构

```
my-vue-app/
├── src/                          # Vue.js 源代码
│   ├── components/
│   │   ├── HelloWorld.vue        # 示例组件
│   │   └── TestComponent.vue     # 测试用组件
│   ├── utils/
│   │   └── testUtils.js          # 测试工具函数
│   ├── App.vue                   # 主应用组件
│   └── main.js                   # 应用入口
├── public/                       # 静态资源
├── full-dist-comparison-test.js  # 主测试脚本
├── package.json                  # 项目依赖
└── README.md                     # 项目文档
```

## 安装和运行

### 环境要求
- Node.js >= 14.0.0
- npm 或 pnpm

### 安装依赖
```bash
# 使用 npm
npm install

# 或使用 pnpm
pnpm install
```

### 运行测试
```bash
# 执行完整的构建一致性测试
node full-dist-comparison-test.js
```

## 测试用例说明

### 测试流程概述

测试脚本 `full-dist-comparison-test.js` 执行以下步骤：

1. **初始构建分析** - 分析原始代码的构建结果
2. **代码修改测试** - 修改 TestComponent.vue 并重新构建
3. **并行构建验证** - 使用 5 个 Worker 进程并行构建
4. **结果对比分析** - 对比所有构建结果的一致性
5. **临时文件清理** - 清理测试过程中的临时文件
6. **环境恢复** - 恢复原始的 TestComponent.vue

### 测试用例详情

#### 1. 构建一致性测试
- **目的**: 验证相同代码多次构建产生相同结果
- **方法**: 使用 Worker 进程并行执行 5 次构建
- **验证**: 比较所有构建产物的 MD5 哈希值

#### 2. 代码变化检测测试
- **目的**: 验证代码修改后构建结果确实发生变化
- **方法**: 修改 TestComponent.vue 的内容并重新构建
- **验证**: 确保修改后的哈希值与原始版本不同

#### 3. 高负载并行测试
- **目的**: 测试高负载情况下构建的稳定性
- **方法**: 使用 Node.js Worker 线程同时执行多个构建任务
- **验证**: 确保所有并行构建的结果完全一致

## 调试指南

### 常见问题排查

#### 1. 构建失败
```bash
# 检查 Node.js 版本
node --version

# 检查依赖安装
npm list

# 手动执行构建
npm run build
```

#### 2. 哈希值不一致
- 检查是否有时间戳或随机数生成
- 确认构建环境的一致性
- 查看构建日志中的警告信息

#### 3. Worker 进程错误
- 确保系统有足够的内存
- 检查文件系统权限
- 查看 Worker 进程的错误日志

### 调试模式

可以通过修改测试脚本来启用详细日志：

```javascript
// 在 full-dist-comparison-test.js 中添加调试选项
const DEBUG = true;

if (DEBUG) {
  console.log('详细调试信息...');
}
```

### 手动验证步骤

1. **单次构建验证**:
   ```bash
   npm run build
   ls -la dist/js/
   ```

2. **哈希值计算**:
   ```bash
   # macOS/Linux
   md5 dist/js/*.js
   
   # Windows
   certutil -hashfile dist/js/app.*.js MD5
   ```

3. **文件大小检查**:
   ```bash
   du -h dist/js/*
   ```

## 测试结果说明

### 输出格式

测试脚本会生成详细的表格报告：

#### JS文件构建对比表格
```
┌─────────────────────────────────────────┬─────────────┬─────────────┬──────────────┬─────────────┐
│ JS文件名                                │ 修改后Hash  │ 并行Hash    │ 大小对比     │ 一致性      │
├─────────────────────────────────────────┼─────────────┼─────────────┼──────────────┼─────────────┤
│ js/app.61661577.js                      │ d9565be2    │ d9565be2    │ 6219B vs 6219B │ ✅ 一致     │
│ js/chunk-vendors.1b9a692e.js            │ 6515a637    │ 6515a637    │ 105831B vs 105831B │ ✅ 一致     │
└─────────────────────────────────────────┴─────────────┴─────────────┴──────────────┴─────────────┘
```

#### 一致性统计表
```
┌─────────────────┬──────────┬─────────────┐
│ 统计项目        │ 数量     │ 百分比      │
├─────────────────┼──────────┼─────────────┤
│ 总对比文件      │ 2        │ 100.00%     │
│ 一致文件        │ 2        │ 100.00%     │
│ 不一致文件      │ 0        │ 0.00%       │
└─────────────────┴──────────┴─────────────┘
```

### 结果解读

#### ✅ 测试通过的标志
- 所有并行构建的哈希值完全一致
- 文件大小完全相同
- 一致性百分比为 100%

#### ❌ 需要关注的情况
- 哈希值不一致：可能存在非确定性构建
- 文件大小差异：构建过程可能有问题
- 一致性百分比低于 100%：需要进一步调查

### 性能指标

测试脚本还会记录：
- 单次构建时间
- 并行构建总时间
- 文件分析耗时
- 内存使用情况

## 扩展测试

### 添加新的测试用例

1. 在 `src/components/` 中创建新的测试组件
2. 修改 `full-dist-comparison-test.js` 添加新的测试逻辑
3. 更新测试流程文档

### 自定义构建配置

可以通过修改 `vue.config.js` 来测试不同的构建配置：

```javascript
module.exports = {
  // 禁用文件名哈希（用于测试）
  filenameHashing: false,
  
  // 自定义输出目录
  outputDir: 'custom-dist',
  
  // 生产环境源码映射
  productionSourceMap: false
}
```
